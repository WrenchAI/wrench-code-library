

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WrenchCL.DataFlow.handle_lambda_response &mdash; WrenchCL 0.0.1.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=75d19225"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            WrenchCL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/modules.html">WrenchCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">WrenchCL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">WrenchCL.DataFlow.handle_lambda_response</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for WrenchCL.DataFlow.handle_lambda_response</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (c) $YEAR$. Copyright (c) $YEAR$ Wrench.AI., Willem van der Schans, Jeong Kim</span>
<span class="c1">#</span>
<span class="c1">#  MIT License</span>
<span class="c1">#</span>
<span class="c1">#  Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1">#  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1">#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1">#  All works within the Software are owned by their respective creators and are distributed by Wrench.AI.</span>
<span class="c1">#</span>
<span class="c1">#  For inquiries, please contact Willem van der Schans through the official Wrench.AI channels or directly via GitHub at [Kydoimos97](https://github.com/Kydoimos97).</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">boto3</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">boto3client</span>

<span class="kn">from</span> <span class="nn">..Tools.TypeChecker</span> <span class="kn">import</span> <span class="n">typechecker</span>  <span class="c1"># Update this to the correct import path</span>
<span class="kn">from</span> <span class="nn">..Tools</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">.build_return_json</span> <span class="kn">import</span> <span class="n">build_return_json</span>
<span class="kn">from</span> <span class="nn">.trigger_dataflow_metrics</span> <span class="kn">import</span> <span class="n">trigger_minimum_dataflow_metrics</span>

<span class="n">lambda_response</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="GuardedResponseTrigger">
<a class="viewcode-back" href="../../../modules/WrenchCL.DataFlow.html#WrenchCL.DataFlow.handle_lambda_response.GuardedResponseTrigger">[docs]</a>
<span class="k">class</span> <span class="nc">GuardedResponseTrigger</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom exception to signal early exit from the Lambda function.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>

<div class="viewcode-block" id="GuardedResponseTrigger.get_response">
<a class="viewcode-back" href="../../../modules/WrenchCL.DataFlow.html#WrenchCL.DataFlow.handle_lambda_response.GuardedResponseTrigger.get_response">[docs]</a>
    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the response associated with this exception.</span>

<span class="sd">        :returns: The response dictionary associated with this exception.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span></div>
</div>



<div class="viewcode-block" id="handle_lambda_response">
<a class="viewcode-back" href="../../../modules/WrenchCL.DataFlow.html#WrenchCL.DataFlow.handle_lambda_response.handle_lambda_response">[docs]</a>
<span class="k">def</span> <span class="nf">handle_lambda_response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">response_body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles Lambda function responses, providing detailed custom error logging while</span>
<span class="sd">    ensuring valid HTTP status codes in API responses.</span>

<span class="sd">    Custom Error Code Mapping (Logged vs. API Response Codes):</span>
<span class="sd">        - Logged Codes (4xx, 5xx):</span>
<span class="sd">            - 400: Validation Error (Bad request, malformed inputs).</span>
<span class="sd">            - 401: Unauthorized (Invalid credentials, session expired).</span>
<span class="sd">            - 403: Forbidden (Permission denied, restricted access).</span>
<span class="sd">            - 404: Resource Not Found.</span>
<span class="sd">            - 409: Conflict (Resource locks, version conflicts).</span>
<span class="sd">            - 429: Rate Limit Exceeded.</span>
<span class="sd">            - 500: General Server Error (Unhandled exceptions, internal issues).</span>
<span class="sd">            - 502: Dependency Error (External service failures).</span>
<span class="sd">            - 503: Service Unavailable (System overload, downtime).</span>
<span class="sd">            - 504: Gateway Timeout (Function timeout, resource unavailability).</span>
<span class="sd">            - 550: Generic Custom Error (Unspecified issues for tracking purposes).</span>
<span class="sd">            - 551: Data Validation Error (Invalid inputs or constraints).</span>
<span class="sd">            - 552: Resource Lock or Conflict.</span>
<span class="sd">            - 553: Model or AI-related issues.</span>
<span class="sd">            - 554: API Gateway or Lambda-specific errors.</span>
<span class="sd">        - Returned API Codes:</span>
<span class="sd">            - 4xx (Client Errors): Mapped based on the custom code (400, 401, 403, etc.).</span>
<span class="sd">            - 5xx (Server Errors): Generalized to standard HTTP codes (500, 502, etc.).</span>

<span class="sd">    :param int code: Internal custom error code for logging purposes.</span>
<span class="sd">    :param str message: A descriptive message about the status or error.</span>
<span class="sd">    :param dict params: Parameters required for further processing.</span>
<span class="sd">    :param dict response_body: Custom JSON response body (optional).</span>
<span class="sd">    :param str client_id: The client ID (optional).</span>
<span class="sd">    :param str entity_id: The entity ID (optional).</span>

<span class="sd">    :raises GuardedResponseTrigger: Custom exception to signal early exit from the Lambda function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">expected_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;lambda_client&#39;</span><span class="p">:</span> <span class="n">boto3client</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">typechecker</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">expected_types</span><span class="p">,</span> <span class="n">none_is_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lambda_client&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lambda_client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boto3client</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">)</span>

        <span class="n">trigger_minimum_dataflow_metrics</span><span class="p">(</span>
            <span class="n">event</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">context</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">lambda_client</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lambda_client&#39;</span><span class="p">),</span>
            <span class="n">job_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AWS_FUNCTION_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">job_type</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AWS_JOB_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">),</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">exception_msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to invoke dataflow metrics with error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Consolidated Custom Error Messages</span>
    <span class="n">custom_error_messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">400</span><span class="p">:</span> <span class="s2">&quot;Validation Error: Malformed or invalid request.&quot;</span><span class="p">,</span>
        <span class="mi">401</span><span class="p">:</span> <span class="s2">&quot;Unauthorized: Invalid credentials or session expired.&quot;</span><span class="p">,</span>
        <span class="mi">403</span><span class="p">:</span> <span class="s2">&quot;Forbidden: Access denied or restricted.&quot;</span><span class="p">,</span>
        <span class="mi">404</span><span class="p">:</span> <span class="s2">&quot;Resource Not Found: The requested resource does not exist.&quot;</span><span class="p">,</span>
        <span class="mi">409</span><span class="p">:</span> <span class="s2">&quot;Conflict: Resource is locked or has version conflicts.&quot;</span><span class="p">,</span>
        <span class="mi">429</span><span class="p">:</span> <span class="s2">&quot;Rate Limit Exceeded: Too many requests.&quot;</span><span class="p">,</span>
        <span class="mi">500</span><span class="p">:</span> <span class="s2">&quot;Internal Server Error: An unexpected server-side issue occurred.&quot;</span><span class="p">,</span>
        <span class="mi">502</span><span class="p">:</span> <span class="s2">&quot;Dependency Error: External service failure.&quot;</span><span class="p">,</span>
        <span class="mi">503</span><span class="p">:</span> <span class="s2">&quot;Service Unavailable: System overload or downtime.&quot;</span><span class="p">,</span>
        <span class="mi">504</span><span class="p">:</span> <span class="s2">&quot;Gateway Timeout: Function timed out before completion.&quot;</span><span class="p">,</span>
        <span class="mi">550</span><span class="p">:</span> <span class="s2">&quot;Generic Custom Error: Unspecified issue for tracking purposes.&quot;</span><span class="p">,</span>
        <span class="mi">551</span><span class="p">:</span> <span class="s2">&quot;Data Validation Error: Inputs failed validation.&quot;</span><span class="p">,</span>
        <span class="mi">552</span><span class="p">:</span> <span class="s2">&quot;Resource Conflict: Resource is locked or conflicting.&quot;</span><span class="p">,</span>
        <span class="mi">553</span><span class="p">:</span> <span class="s2">&quot;Model Error: AI/ML operation failed.&quot;</span><span class="p">,</span>
        <span class="mi">554</span><span class="p">:</span> <span class="s2">&quot;Lambda/API Gateway Error: Integration or execution issue.&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Map custom codes to standard HTTP codes for API responses</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">550</span><span class="p">,</span> <span class="mi">551</span><span class="p">,</span> <span class="mi">552</span><span class="p">,</span> <span class="mi">553</span><span class="p">,</span> <span class="mi">554</span><span class="p">}:</span>
        <span class="n">api_code</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Map custom server-side issues to HTTP 500</span>
    <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">custom_error_messages</span><span class="p">:</span>
        <span class="n">api_code</span> <span class="o">=</span> <span class="n">code</span>  <span class="c1"># Use the provided code for 4xx and common 5xx errors</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">api_code</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Default to HTTP 500 for undefined server errors</span>

    <span class="c1"># Log the error with the internal custom code</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">custom_error_messages</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Custom Code = </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">custom_error_messages</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="si">}</span><span class="s2"> | [Client ID: </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">, Entity ID: </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">] | Status Message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">,</span><span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Custom Code = </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> | Unrecognized Error Code | [Client ID: </span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">, Entity ID: </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">] | Status Message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">,</span><span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Build the response</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">build_return_json</span><span class="p">(</span>
        <span class="n">code</span><span class="o">=</span><span class="n">api_code</span><span class="p">,</span>
        <span class="n">response_body</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">response_body</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built Lambda Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">GuardedResponseTrigger</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Willem van der Schans.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>